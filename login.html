<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Access Portal â€“ Sarvwigyan</title>
    <meta name="description" content="Log in to access Sarvwigyan's innovative educational platforms.">
    <meta name="keywords" content="Sarvwigyan Login, Education Platform, Sign In, Google Login">
    <meta name="author" content="Sarvwigyan Team">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://sarvwigyan.github.io/login.html" />
    <meta property="og:title" content="Login to Sarvwigyan">
    <meta property="og:description" content="Access your Sarvwigyan account to explore science, education, and innovation.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://sarvwigyan.github.io/login.html">
    <meta property="og:image" content="https://sarvwigyan.github.io/Resources/Sarvwigyan.png">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon" href="https://sarvwigyan.github.io/Resources/Sarvwigyan.png" type="image/png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root { --bg: #fafafa; --card: #ffffff; --text: #1a1a1a; --muted: #6b7280; --primary: #2563eb; --accent: #10b981; }
        [data-theme="dark"] { --bg: #1f1f1f; --card: #2d2d2d; --text: #f3f4f6; --muted: #9ca3af; --primary: #3b82f6; --accent: #34d399; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
        body { background:var(--bg); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; }
        .login-container { background:var(--card); padding:3rem; border-radius:16px; box-shadow:0 20px 40px rgba(0,0,0,0.1); text-align:center; max-width:400px; width:90%; }
        .logo { width:90px; height:90px; background:linear-gradient(135deg,var(--primary),var(--accent)); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; }
        .logo i { color:white; font-size:48px; }
        h1 { font-size:1.9rem; margin-bottom:0.5rem; }
        p { color:var(--muted); margin-bottom:2rem; }
        .google-btn {
            background:#4285f4; color:white; border:none; padding:14px 32px; border-radius:12px; font-size:16px; font-weight:600;
            cursor:pointer; display:inline-flex; align-items:center; gap:12px; box-shadow:0 4px 15px rgba(66,133,244,0.4);
            transition:all 0.3s;
        }
        .google-btn:hover { background:#3367d6; transform:translateY(-2px); }
        .footer { margin-top:2rem; font-size:0.875rem; color:var(--muted); }
        @media (max-width:480px) { .login-container { padding:2rem; } h1 { font-size:1.6rem; } }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo"><i class="material-icons">lightbulb</i></div>
        <h1>Welcome to Sarvwigyan</h1>
        <p>Sign in with Google to continue</p>
        <button onclick="signInWithGoogle()" class="google-btn">
            <i class="fab fa-google"></i> Sign in with Google
        </button>
        <div class="footer"><p>Â© 2025 Sarvwigyan. All rights reserved.</p></div>
    </div>

    <!-- Firebase SDK (production-ready) -->
    <script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyCIGRKHyP60pqyrmoERdWqnO6vCTGT4JsI",
    authDomain: "sarvwigyan-auth.firebaseapp.com",
    projectId: "sarvwigyan-auth",
    storageBucket: "sarvwigyan-auth.firebasestorage.app",
    messagingSenderId: "503809453858",
    appId: "1:503809453858:web:8507f6c59d854a67f57f7b",
    measurementId: "G-BV5G1LSH6F"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

provider.setCustomParameters({ prompt: 'select_account' });

window.signInWithGoogle = async () => {
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        console.log("âœ… Google login successful:", user.email);

        // Check if user already exists in Firestore
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);

        let userData;
        
        if (!userDocSnap.exists()) {
            // New user - create full profile
            userData = {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                emailVerified: user.emailVerified,
                phoneNumber: user.phoneNumber || null,
                createdAt: user.metadata.creationTime,
                lastLoginAt: new Date().toISOString(),
                lastSignInTime: user.metadata.lastSignInTime,
                profile: {
                    fullName: user.displayName,
                    bio: "Technology enthusiast and lifelong learner. Passionate about AI, web development, and open-source projects.",
                    location: "Not specified"
                },
                statistics: {
                    projects: 12,
                    connections: 48,
                    activityScore: 87
                },
                security: {
                    twoFactorEnabled: false,
                    securityLevel: "high"
                },
                preferences: {
                    theme: "system",
                    language: "english",
                    emailNotifications: true,
                    pushNotifications: true
                },
                updatedAt: new Date().toISOString(),
                loginCount: 1
            };

            await setDoc(userDocRef, userData);
            console.log("ðŸ†• New user profile created in Firestore");
        } else {
            // Existing user - update login info
            userData = userDocSnap.data();
            await setDoc(userDocRef, {
                lastLoginAt: new Date().toISOString(),
                loginCount: (userData.loginCount || 0) + 1,
                updatedAt: new Date().toISOString()
            }, { merge: true });
            console.log("ðŸ”„ Existing user profile updated in Firestore");
        }

        // Create localStorage data
        const localStorageUser = {
            userId: user.uid,
            name: user.displayName,
            email: user.email,
            picture: user.photoURL,
            fullName: user.displayName,
            accountCreated: user.metadata.creationTime,
            lastLogin: new Date().toISOString(),
            phoneNumber: user.phoneNumber || 'Not provided',
            location: 'Not specified',
            bio: userData.profile?.bio || "Technology enthusiast and lifelong learner.",
            stats: userData.statistics || { projects: 12, connections: 48, activityScore: 87 },
            twoFactorEnabled: false,
            securityStatus: 'strong',
            themePreference: 'System default',
            languagePreference: 'English',
            notificationSettings: 'All notifications'
        };

        localStorage.setItem('user', JSON.stringify(localStorageUser));
        console.log("ðŸ’¾ localStorage updated");

        // ONLY NOW redirect after everything is done
        window.location.href = "index.html";

    } catch (error) {
        console.error("âŒ Login failed:", error);
        alert("Login failed. Please try again.");
    }
};

// REMOVE or COMMENT OUT the onAuthStateChanged listener on login page
// This is what was causing the race condition!
/*
auth.onAuthStateChanged(user => {
    if (user) {
        window.location.href = "index.html";
    }
});
*/
</script>
</body>
</html>